name: Deploy to AWS EC2

on:
  push:
    branches: [main]
    paths:
      ["apps/api/**", "docker-compose.yml ", ".github/workflows/deploy-api.yml"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          platforms: linux/amd64
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/stepexplorer-api:latest

      - name: Deploy to EC2
        run: |
          echo "ðŸš€ Deploying to EC2..."
          if ! command -v git &> /dev/null; then
            echo "ðŸ“¦ Installing git..."
            sudo yum install -y git
          fi

          # Get the EC2 instance IP
          EC2_IP=$(aws ec2 describe-addresses \
            --filters "Name=tag:Name,Values=stepexplorer-api-eip" \
            --query 'Addresses[0].PublicIp' --output text)

          echo "ðŸ“ EC2 IP: $EC2_IP"

          # Setup SSH
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem

          # Add EC2 to known hosts
          mkdir -p ~/.ssh
          ssh-keyscan -H $EC2_IP >> ~/.ssh/known_hosts

          # Deploy to EC2
          ssh -i private_key.pem -o StrictHostKeyChecking=no ec2-user@$EC2_IP << 'ENDSSH'
            set -e
            
            echo "ðŸš€ Starting deployment on EC2..."
            
            # Clone/pull latest code to get updated docker-compose.yml
            if [ ! -d "/opt/stepexplorer-repo" ]; then
              sudo git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git /opt/stepexplorer-repo
              sudo chown -R ec2-user:ec2-user /opt/stepexplorer-repo
            else
              cd /opt/stepexplorer-repo
              git pull origin main
            fi
            
            # Copy the latest docker-compose.yml
            cp /opt/stepexplorer-repo/docker-compose.yml /opt/stepexplorer/
            
            # Create environment file
            cd /opt/stepexplorer
            cat > .env << EOF
            NODE_ENV=production
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            REDIS_URL=redis://redis:6379
            EOF
            
            # Login to ECR
            aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 130046065749.dkr.ecr.us-east-1.amazonaws.com
            
            # Pull latest image
            echo "ðŸ“¦ Pulling latest image..."
            docker-compose pull api
            
            # Run migrations
            echo "ðŸ—„ï¸ Running database migrations..."
            docker-compose run --rm api npm run db:migrate
            
            # Restart services
            echo "ðŸ”„ Restarting services..."
            docker-compose down
            docker-compose up -d
            
            # Cleanup old images
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment completed!"
          ENDSSH

          # Cleanup
          rm private_key.pem

          echo "ðŸŽ‰ Deployment to EC2 successful!"

      - name: Health Check
        run: |
          echo "ðŸ¥ Performing health check..."

          # Get the EC2 instance IP
          EC2_IP=$(aws ec2 describe-addresses \
            --filters "Name=tag:Name,Values=stepexplorer-api-eip" \
            --query 'Addresses[0].PublicIp' --output text)

          # Wait for service to be ready
          sleep 30

          # Health check
          for i in {1..5}; do
            if curl -f http://$EC2_IP/health; then
              echo "âœ… Health check passed!"
              break
            else
              echo "â³ Waiting for service... (attempt $i/5)"
              sleep 10
            fi
          done
